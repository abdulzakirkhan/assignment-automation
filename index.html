<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Assignment Generator</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
</head>
<body class="light-theme" >
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="" class="logo">
                <i class="fas fa-graduation-cap"></i>
                AssignmentGenius
            </a>
            <ul class="nav-menu" id="navMenu">
                <li class="nav-item active" data-page="dashboard">
                    <i class="fas fa-home"></i> Dashboard
                </li>
                <li class="nav-item" data-page="create">
                    <i class="fas fa-plus-circle"></i> Create Assignment
                </li>
                <li class="nav-item" data-page="generate">
                    <i class="fas fa-magic"></i> Generate
                </li>
                <li class="nav-item" data-page="title">
                    <i class="fas fa-magic"></i> Title
                </li>
                <li class="nav-item" data-page="history">
                    <i class="fas fa-history"></i> History
                </li>
                <li class="nav-item" data-page="help">
                    <i class="fas fa-question-circle"></i> Help
                </li>


            </ul>
            <div class="form-group" style="margin-bottom: -14px;">
                <!-- <label class="form-label" for="themeSwitch">Theme</label> -->
                <label class="switch">
                    <input type="checkbox" id="themeSwitch" onchange="toggleSwitchTheme(this)">
                    <span class="slider"></span>
                </label>
            </div>
            <button class="mobile-menu-btn" id="mobileMenuBtn">
                <i class="fas fa-bars"></i>
            </button>
            
        </div>
    </nav>

    <div class="container">
        <!-- Dashboard Page -->
        <div id="dashboard" class="page active">
            <div class="dashboard-header">
                <h1 class="dashboard-title">
                    <i class="fas fa-robot animate-bounce"></i>
                    Welcome to AssignmentGenius
                </h1>
                <p class="dashboard-subtitle">
                    Professional AI-Powered Academic Writing Assistant
                </p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <i class="fas fa-file-alt stat-icon"></i>
                    <div class="stat-number" id="totalAssignments">0</div>
                    <div class="stat-label">Total Assignments</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-check-circle stat-icon"></i>
                    <div class="stat-number" id="completedAssignments">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-download stat-icon"></i>
                    <div class="stat-number" id="downloadsCount">0</div>
                    <div class="stat-label">Downloads</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-clock stat-icon"></i>
                    <div class="stat-number" id="processingTime">~5min</div>
                    <div class="stat-label">Avg. Processing</div>
                </div>
            </div>

            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-rocket"></i>
                        </div>
                        <div class="card-title">Quick Start</div>
                    </div>
                    <ul class="features-list">
                        <li>Upload your assignment brief</li>
                        <li>Add module materials (optional)</li>
                        <li>Generate professional outline</li>
                        <li>Create complete assignment</li>
                        <li>Download formatted DOCX</li>
                    </ul>
                    <button class="btn btn-primary btn-full" onclick="showPage('create')">
                        <i class="fas fa-play"></i> Start New Assignment
                    </button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="card-title">Advanced Features</div>
                    </div>
                    <ul class="features-list">
                        <li>Exact word count compliance</li>
                        <li>Professional academic formatting</li>
                        <li>Auto-generated citations</li>
                        <li>University-style layout</li>
                        <li>Multiple file format support</li>
                    </ul>
                    <button class="btn btn-secondary btn-full" onclick="showPage('help')">
                        <i class="fas fa-info-circle"></i> Learn More
                    </button>
                </div>
            </div>
        </div>

        <!-- Create Assignment Page -->
        <div id="create" class="page">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-file-upload"></i>
                    </div>
                    <div class="card-title">Create New Assignment</div>
                </div>

                <form id="extractForm" enctype="multipart/form-data">
                    <div class="grid grid-2">
                        <!-- Assignment Brief Upload -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-file-text"></i> Assignment Brief (Required)
                            </label>
                            <div class="file-upload-area" onclick="document.getElementById('assignmentFile').click()">
                                <i class="fas fa-cloud-upload-alt file-upload-icon"></i>
                                <div class="file-upload-text">Click to upload or drag & drop</div>
                                <div class="file-upload-hint">PDF, DOC, DOCX, PPT, PPTX, Images, ZIP, RAR</div>
                            </div>

                            <!-- File input -->
                            <input type="file" id="assignmentFile" name="file" class="file-input" 
                                accept=".pdf,.doc,.docx,.ppt,.pptx,.jpg,.jpeg,.png,.zip,.rar,.tar,.tar.gz" multiple>

                            <!-- File list container -->
                            <div id="assignmentFileSelected" class="file-selected" style="display:none;">
                                <!-- <i class="fas fa-check-circle"></i> -->
                                <div id="assignmentFileList" class="file-list"></div> <!-- Badges will appear here -->
                            </div>
                        </div>

                         <!-- Module Materials Upload -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-folder-open"></i> Module Materials (Optional)
                            </label>
                            <div class="file-upload-area" onclick="document.getElementById('helpingMaterial').click()">
                                <i class="fas fa-archive file-upload-icon"></i>
                                <div class="file-upload-text">Upload ZIP file</div>
                                <div class="file-upload-hint">Lecture notes, readings, handouts</div>
                            </div>
                            <input type="file" id="helpingMaterial" name="helping_material" class="file-input" 
                                accept=".pdf,.doc,.docx,.ppt,.pptx,.jpg,.jpeg,.png,.zip,.rar,.tar,.tar.gz" multiple>
                            <div id="helpingMaterialSelected" class="file-selected" style="display:none;">
                                <!-- <i class="fas fa-check-circle"></i> -->
                                <div id="helpingMaterialList" class="file-list"></div>
                            </div>
                        </div>

                        
                    </div>

                    <!-- Additional Information -->
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-info-circle"></i> Additional Information (Optional)
                        </label>
                        <textarea 
                            name="additional_information" 
                            class="form-input textarea" 
                            placeholder="Provide any additional context, specific requirements, instructions, or guidelines that will help generate a better assignment..."
                        ></textarea>
                    </div>

                    <!-- Features Info -->
                    <div class="info-card">
                        <h4 style="color: var(--primary-blue); margin-bottom: 1rem;">
                            <i class="fas fa-magic"></i> What happens next?
                        </h4>
                        <ul class="features-list">
                            <li>AI analyzes your assignment requirements</li>
                            <li>Extracts structure and key details</li>
                            <li>Generates comprehensive outline</li>
                            <li>Saves to database for generation</li>
                            <li>Provides assignment ID for tracking</li>
                        </ul>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="btn btn-primary btn-full" id="extractBtn">
                        <i class="fas fa-magic"></i>
                        Generate Assignment Outline
                    </button>
                </form>

                <!-- Status Container -->
                <div id="extractStatus" class="status-container">
                    <div id="extractMessage"></div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="extractProgress"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Generate Assignment Page -->
        <div id="generate" class="page">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-cogs"></i>
                    </div>
                    <div class="card-title">Generate Professional Assignment</div>
                </div>

                <!-- Assignment Info Display -->
                <div class="info-card" id="assignmentInfoCard" style="display: none;">
                    <h4 style="color: var(--primary-blue); margin-bottom: 1rem;">
                        <i class="fas fa-info-circle"></i> Assignment Details
                    </h4>
                    <div class="info-item">
                        <span class="info-label">Assignment ID:</span>
                        <span class="info-value" id="displayAssignmentId">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Type:</span>
                        <span class="info-value" id="displayAssignmentType">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Word Count:</span>
                        <span class="info-value" id="displayWordCount">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Topic:</span>
                        <span class="info-value" id="displayTopic">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">University:</span>
                        <span class="info-value" id="displayUniversity">-</span>
                    </div>
                </div>

                <!-- Manual Assignment ID Input -->
                <div class="form-group" id="manualIdInput">
                    <label class="form-label">
                        <i class="fas fa-hashtag"></i> Assignment ID
                    </label>
                    <input type="number" id="manualAssignmentId" class="form-input" 
                           placeholder="Enter assignment ID to generate..." min="1">
                    <button type="button" class="btn btn-secondary" onclick="loadAssignmentInfo()" style="margin-top: 1rem;">
                        <i class="fas fa-search"></i> Load Assignment Info
                    </button>
                </div>

                <!-- Advanced Features Info -->
                <div class="info-card">
                    <h4 style="color: var(--success); margin-bottom: 1rem;">
                        <i class="fas fa-rocket"></i> Advanced Generation Features
                    </h4>
                    <div class="grid grid-2">
                        <ul class="features-list">
                            <li>Exact word count compliance</li>
                            <li>Professional academic formatting</li>
                            <li>Auto-generated citations</li>
                            <li>University-style title page</li>
                        </ul>
                        <ul class="features-list">
                            <li>Table of contents</li>
                            <li>No section conclusions</li>
                            <li>Quality control system</li>
                            <li>Instant DOCX download</li>
                        </ul>
                    </div>
                </div>

                <!-- Generate Button -->
                <button class="btn btn-success btn-full" id="generateBtn" onclick="generateAssignment()">
                    <i class="fas fa-play"></i>
                    Generate Professional Assignment
                </button>

                <!-- Generation Status -->
                <div id="generateStatus" class="status-container">
                    <div id="generateMessage"></div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="generateProgress"></div>
                    </div>
                </div>

                <!-- Download Section -->
                <div class="download-section" id="downloadSection">
                    <i class="fas fa-download download-icon"></i>
                    <div class="download-text">Assignment Generated Successfully!</div>
                    <div style="margin-bottom: 1rem; color: #065f46;">
                        <div><strong>📄 Sections Generated:</strong> <span id="sectionsGenerated">-</span></div>
                        <div><strong>📝 Total Words:</strong> <span id="totalWords">-</span></div>
                        <div><strong>📖 Citations Found:</strong> <span id="citationsFound">-</span></div>
                    </div>
                    <button class="btn btn-success" id="downloadBtn" onclick="downloadAssignment()">
                        <i class="fas fa-file-word"></i>
                        Download DOCX File
                    </button>
                </div>
            </div>
        </div>

        <!-- Generate Assignment Page -->
        <div id="title" class="page">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Title Page</div>
                </div>
                <div class="card-body">
                    <h1>Hi this is Title page card body</h1>
                </div>
            </div>
        </div>

        <!-- History Page -->
        <div id="history" class="page">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="card-title">Assignment History</div>
                </div>

                <div class="form-group">
                    <button class="btn btn-primary" onclick="loadAssignmentHistory()">
                        <i class="fas fa-refresh"></i>
                        Refresh History
                    </button>
                </div>

                <div style="overflow-x: auto;">
                    <table class="history-table" id="historyTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Type</th>
                                <th>Topic</th>
                                <th>Word Count</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <!-- <tr>
                                <td colspan="7" style="text-align: center; padding: 3rem; color: var(--gray);">
                                    <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                                    No assignments found. Create your first assignment!
                                </td>
                            </tr> -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Help Page -->
        <div id="help" class="page">
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-question-circle"></i>
                        </div>
                        <div class="card-title">How It Works</div>
                    </div>
                    <div style="space-y: 1.5rem;">
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="color: var(--primary-blue); margin-bottom: 0.5rem;">Step 1: Upload Brief</h4>
                            <p>Upload your assignment brief in any supported format (PDF, DOC, DOCX, PPT, etc.). You can also include module materials as a ZIP file.</p>
                        </div>
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="color: var(--primary-blue); margin-bottom: 0.5rem;">Step 2: AI Analysis</h4>
                            <p>Our AI analyzes your brief, extracts requirements, word counts, deadlines, and generates a comprehensive outline.</p>
                        </div>
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="color: var(--primary-blue); margin-bottom: 0.5rem;">Step 3: Generate Assignment</h4>
                            <p>Click generate to create a professional assignment with proper formatting, citations, and academic structure.</p>
                        </div>
                        <div>
                            <h4 style="color: var(--primary-blue); margin-bottom: 0.5rem;">Step 4: Download</h4>
                            <p>Download your completed assignment as a formatted DOCX file ready for submission.</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="card-title">Supported Formats</div>
                    </div>
                    <div style="space-y: 1rem;">
                        <div style="margin-bottom: 1rem;">
                            <h5 style="color: var(--dark-blue);">Document Formats</h5>
                            <ul class="features-list">
                                <li>PDF (.pdf)</li>
                                <li>Microsoft Word (.doc, .docx)</li>
                                <li>PowerPoint (.ppt, .pptx)</li>
                            </ul>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <h5 style="color: var(--dark-blue);">Image Formats</h5>
                            <ul class="features-list">
                                <li>JPEG (.jpg, .jpeg)</li>
                                <li>PNG (.png)</li>
                                <li>JFIF (.jfif)</li>
                            </ul>
                        </div>
                        <div>
                            <h5 style="color: var(--dark-blue);">Archive Formats</h5>
                            <ul class="features-list">
                                <li>ZIP (.zip)</li>
                                <li>RAR (.rar)</li>
                                <li>TAR (.tar, .tar.gz)</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="card-title">Key Features</div>
                    </div>
                    <ul class="features-list">
                        <li>AI-powered content generation</li>
                        <li>Strict word count compliance</li>
                        <li>Professional academic formatting</li>
                        <li>Automatic citation generation</li>
                        <li>University-style title pages</li>
                        <li>Table of contents generation</li>
                        <li>Multiple file format support</li>
                        <li>Module material integration</li>
                        <li>Quality control systems</li>
                        <li>Instant DOCX download</li>
                    </ul>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-cog"></i>
                        </div>
                        <div class="card-title">System Settings</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Backend API URL</label>
                        <input type="url" id="apiUrlInput" class="form-input" value="http://localhost:8000" placeholder="http://localhost:8000">
                        <button class="btn btn-secondary" onclick="updateApiUrl()" style="margin-top: 0.5rem;">
                            <i class="fas fa-save"></i> Update URL
                        </button>
                    </div>
                    <!-- <div class="form-group">
                        <label class="form-label">Theme</label>
                        <select class="form-input" onchange="toggleTheme(this.value)">
                            <option value="light">Light Theme</option>
                            <option value="dark">Dark Theme (Coming Soon)</option>
                        </select>
                    </div> -->
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        // Global Configuration
        let API_BASE_URL = 'http://localhost:8000';
        let currentAssignmentId = null;
        let currentDocxFile = null;
        // File Handling
       let assignmentFiles = [];
        let helpingMaterialFiles = [];
        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            onLoadDom();
        });

        function initializeApp() {
            setupEventListeners();
            setupDragAndDrop();
            loadDashboardStats();
            
            // Load saved API URL
            const savedApiUrl = localStorage.getItem('apiUrl');
            if (savedApiUrl) {
                API_BASE_URL = savedApiUrl;
                document.getElementById('apiUrlInput').value = savedApiUrl;
            }
        }

        // Load saved theme on page load
    
        function onLoadDom () {
            const savedTheme = localStorage.getItem('theme') || 'light';

            // Apply the saved theme
            toggleTheme(savedTheme);

            // Update the switch state
            const themeSwitch = document.getElementById('themeSwitch');
            if (themeSwitch) {
                themeSwitch.checked = savedTheme === 'dark';
            }
        }

        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const pageId = this.getAttribute('data-page');
                    showPage(pageId);
                });
            });

            // Mobile menu
            document.getElementById('mobileMenuBtn').addEventListener('click', function() {
                document.getElementById('navMenu').classList.toggle('show');
            });

            // File inputs
            // Event listeners for both inputs
            document.getElementById('assignmentFile').addEventListener('change', function(e) {
                handleFileSelect(e, 'assignmentFileSelected', 'assignmentFileList', assignmentFiles);
            });

            document.getElementById('helpingMaterial').addEventListener('change', function(e) {
                handleFileSelect(e, 'helpingMaterialSelected', '', helpingMaterialFiles);
            });

            // Form submission
            document.getElementById('extractForm').addEventListener('submit', handleExtractSubmission);
        }

        function setupDragAndDrop() {
            const uploadAreas = document.querySelectorAll('.file-upload-area');
            
            uploadAreas.forEach(area => {
                area.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('dragover');
                });

                area.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                });

                area.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const input = this.parentNode.querySelector('input[type="file"]');
                        input.files = files;
                        input.dispatchEvent(new Event('change'));
                    }
                });
            });
        }

        // Page Navigation
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            // Show selected page
            document.getElementById(pageId).classList.add('active');

            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-page="${pageId}"]`).classList.add('active');

            // Close mobile menu
            document.getElementById('navMenu').classList.remove('show');

            // Load page-specific data
            if (pageId === 'dashboard') {
                loadDashboardStats();
            } else if (pageId === 'history') {
                loadAssignmentHistory();
            }
        }

        

        // updated
        function handleFileSelect(event, selectedId, listContainerId, fileArray) {
            const newFiles = Array.from(event.target.files);

            // Merge new files, avoid duplicates
            newFiles.forEach(file => {
                if (!fileArray.some(f => f.name === file.name && f.size === file.size)) {
                    fileArray.push(file);
                }
            });

            const fileListContainer = document.getElementById(listContainerId);
            const parentContainer = document.getElementById(selectedId);

            // Clear old badges
            fileListContainer.innerHTML = '';

            // Create badges
            fileArray.forEach((file, index) => {
                const badge = document.createElement('div');
                badge.classList.add('file-badge');
                badge.innerHTML = `
                    <div class="fs-16" style="width:100%; display:flex; align-items: center; gap: 8px;">
                        <i class="fas fs-17 fa-check-circle" style="color:green;"></i>
                        <div class="" style="display:flex; justify-content: space-between; align-items: center; width:90%;">
                            ${file.name} <i class="fas fa-trash" title="Remove"></i>
                        </div>
                    </div>
                `;


                // badge.querySelector('i').addEventListener('click', () => {
                //     console.log("fileid",file.name)
                //     fileArray.splice(file, 1);
                //     badge.remove();
                //     if (fileArray.length === 0) {
                //         parentContainer.style.display = 'none';
                //     }
                // });

                // Remove file functionality
                badge.querySelector('.fa-trash').addEventListener('click', () => {
                    console.log("fileid",file.name)
                    fileArray.splice(file, 1);
                    badge.remove();
                    if (fileArray.length === 0) {
                        parentContainer.style.display = 'none';
                    }
                    showToast(`File Removed`, 'success');
                });

                fileListContainer.appendChild(badge);
            });

            // Show parent only if there are files
            if (fileArray.length > 0) {
                parentContainer.style.display = 'block';
            } else {
                parentContainer.style.display = 'none';
            }

            showToast(`${newFiles.length} ${newFiles.length > 1 ? "Files" : "File"} Selected`, 'success');
        }
        // old function
        // function handleFileSelect(event, selectedId, nameId) {
        //     const file = event.target.files[0];
        //     if (file) {
        //         document.getElementById(selectedId).style.display = 'block';
        //         document.getElementById(nameId).textContent = file.name;
        //         showToast(`File selected: ${file.name}`, 'success');
        //     }
        // }

        // Extract Assignment (Step 1)
        async function handleExtractSubmission(event) {
            event.preventDefault();
            
            const formData = new FormData();
            const assignmentFile = document.getElementById('assignmentFile').files[0];
            const helpingMaterial = document.getElementById('helpingMaterial').files[0];
            const additionalInfo = document.querySelector('textarea[name="additional_information"]').value;

            // Validation
            if (!assignmentFile) {
                showToast('Please select an assignment brief file', 'error');
                return;
            }

            // Append files and data
            formData.append('file', assignmentFile);
            if (helpingMaterial) {
                formData.append('helping_material', helpingMaterial);
            }
            if (additionalInfo.trim()) {
                formData.append('additional_information', additionalInfo);
            }

            // Show loading state
            const extractBtn = document.getElementById('extractBtn');
            const originalText = extractBtn.innerHTML;
            extractBtn.innerHTML = '<span class="loading-spinner"></span>Processing...';
            extractBtn.disabled = true;

            showStatus('extractStatus', 'Uploading and analyzing files...', 'info');
            updateProgress('extractProgress', 25);

            try {
                const response = await fetch(`${API_BASE_URL}/extract/`, {
                    method: 'POST',
                    body: formData
                });

                updateProgress('extractProgress', 75);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                updateProgress('extractProgress', 100);

                if (result.status === 'complete') {
                    currentAssignmentId = result.data.assignment_id;
                    
                    showStatus('extractStatus', 
                        `✅ Outline generated successfully!<br>
                        📝 Assignment ID: ${currentAssignmentId}<br>
                        📋 Type: ${result.data.assignment_type || 'N/A'}<br>
                        📊 Word Count: ${result.data.word_count || 'N/A'}`, 
                        'success');
                    
                    showToast('Assignment outline generated successfully!', 'success');
                    
                    // Auto-navigate to generation page after 3 seconds
                    setTimeout(() => {
                        populateGenerationPage(result.data);
                        showPage('generate');
                    }, 3000);
                    
                } else {
                    throw new Error('Unexpected response format');
                }

            } catch (error) {
                console.error('Error:', error);
                showStatus('extractStatus', `❌ Error: ${error.message}`, 'error');
                showToast('Failed to generate outline. Please try again.', 'error');
                updateProgress('extractProgress', 0);
            } finally {
                // Reset button
                extractBtn.innerHTML = originalText;
                extractBtn.disabled = false;
            }
        }

        // Generate Assignment (Step 2)
        function populateGenerationPage(data) {
            currentAssignmentId = data.assignment_id;
            
            // Show assignment info
            document.getElementById('assignmentInfoCard').style.display = 'block';
            document.getElementById('manualIdInput').style.display = 'none';
            
            // Populate fields
            document.getElementById('displayAssignmentId').textContent = data.assignment_id || '-';
            document.getElementById('displayAssignmentType').textContent = data.assignment_type || '-';
            document.getElementById('displayWordCount').textContent = data.word_count || '-';
            document.getElementById('displayTopic').textContent = data.paper_topic || '-';
            document.getElementById('displayUniversity').textContent = data.university_name || '-';
        }

        async function loadAssignmentInfo() {
            const assignmentId = document.getElementById('manualAssignmentId').value;
            
            if (!assignmentId) {
                showToast('Please enter an assignment ID', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/assignment/${assignmentId}`);
                
                if (!response.ok) {
                    throw new Error(`Assignment not found`);
                }

                const result = await response.json();
                
                if (result.status === 'success') {
                    populateGenerationPage(result.data);
                    showToast('Assignment info loaded successfully!', 'success');
                } else {
                    throw new Error('Failed to load assignment info');
                }

            } catch (error) {
                console.error('Error:', error);
                showToast(`Error: ${error.message}`, 'error');
            }
        }

        async function generateAssignment() {
            if (!currentAssignmentId) {
                showToast('No assignment ID available. Please load assignment info first.', 'error');
                return;
            }

            const generateBtn = document.getElementById('generateBtn');
            const originalText = generateBtn.innerHTML;
            generateBtn.innerHTML = '<span class="loading-spinner"></span>Generating...';
            generateBtn.disabled = true;

            showStatus('generateStatus', 'Starting professional assignment generation...', 'info');
            updateProgress('generateProgress', 10);

            try {
                const response = await fetch(`${API_BASE_URL}/generate-assignment-advanced/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        assignment_id: currentAssignmentId
                    })
                });

                updateProgress('generateProgress', 50);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                updateProgress('generateProgress', 90);

                if (result.status === 'completed') {
                    currentDocxFile = result.docx_file;
                    
                    updateProgress('generateProgress', 100);
                    showStatus('generateStatus', 
                        `✅ Assignment generated successfully!<br>
                        📄 Professional formatting applied<br>
                        📝 Citations automatically generated<br>
                        🎯 Ready for download`, 
                        'success');
                    
                    // Update download section
                    document.getElementById('sectionsGenerated').textContent = result.sections_generated || '-';
                    document.getElementById('totalWords').textContent = result.estimated_words || '-';
                    document.getElementById('citationsFound').textContent = result.citations_found || '-';
                    
                    showToast('Professional assignment generated successfully!', 'success');
                    
                    // Show download section
                    document.getElementById('downloadSection').style.display = 'block';
                    
                    // Auto-download after 3 seconds
                    setTimeout(() => {
                        downloadAssignment();
                    }, 3000);
                    
                } else {
                    throw new Error(result.error || 'Generation failed');
                }

            } catch (error) {
                console.error('Error:', error);
                showStatus('generateStatus', `❌ Error: ${error.message}`, 'error');
                showToast('Failed to generate assignment. Please try again.', 'error');
                updateProgress('generateProgress', 0);
            } finally {
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
            }
        }

        // Download Assignment
        async function downloadAssignment() {
            if (!currentAssignmentId) {
                showToast('No assignment available for download', 'error');
                return;
            }

            try {
                showToast('Starting download...', 'info');
                
                const response = await fetch(`${API_BASE_URL}/download-assignment/${currentAssignmentId}`);
                
                if (!response.ok) {
                    throw new Error('Download failed');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `assignment_${currentAssignmentId}.docx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                
                showToast('Download completed successfully!', 'success');
                
            } catch (error) {
                console.error('Download error:', error);
                showToast('Download failed. Please try again.', 'error');
            }
        }

        // Dashboard Stats
        async function loadDashboardStats() {
            try {
                // Mock data for now - replace with actual API calls
                document.getElementById('totalAssignments').textContent = '12';
                document.getElementById('completedAssignments').textContent = '10';
                document.getElementById('downloadsCount').textContent = '8';
                document.getElementById('processingTime').textContent = '~4min';
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Assignment History
        async function loadAssignmentHistory() {
            const tableBody = document.getElementById('historyTableBody');
            
            try {
                // Mock data for now - replace with actual API call
                const mockHistory =[
                    {
                        id: 5,
                        type: 'Business Report',
                        topic: 'Strategic Management',
                        wordCount: 2500,
                        status: 'completed',
                        created: '2024-01-15'
                    },
                    {
                        id: 4,
                        type: 'Essay',
                        topic: 'Global Economics',
                        wordCount: 1800,
                        status: 'completed',
                        created: '2024-01-10'
                    },
                    {
                        id: 3,
                        type: 'Research Proposal',
                        topic: 'AI Ethics',
                        wordCount: 3000,
                        status: 'pending',
                        created: '2024-01-08'
                    }
                ];

                if (mockHistory.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 3rem; color: var(--gray);">
                                <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                                No assignments found. Create your first assignment!
                            </td>
                        </tr>`;
                    return;
                }

                tableBody.innerHTML = mockHistory.map(assignment => `
                    <tr>
                        <td>${assignment.id}</td>
                        <td>${assignment.type}</td>
                        <td>${assignment.topic}</td>
                        <td>${assignment.wordCount}</td>
                        <td>
                            <span class="status-badge status-${assignment.status}">
                                ${assignment.status.charAt(0).toUpperCase() + assignment.status.slice(1)}
                            </span>
                        </td>
                        <td>${assignment.created}</td>
                        <td>
                            ${assignment.status === 'completed' ? 
                                `<button class="btn btn-success" onclick="downloadAssignmentById(${assignment.id})" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">
                                    <i class="fas fa-download"></i>
                                </button>` : 
                                `<button class="btn btn-primary" onclick="continueGeneration(${assignment.id})" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">
                                    <i class="fas fa-play"></i>
                                </button>`
                            }
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Error loading history:', error);
                showToast('Failed to load assignment history', 'error');
            }
        }

        async function downloadAssignmentById(id) {
            currentAssignmentId = id;
            await downloadAssignment();
        }

        async function continueGeneration(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/assignment/${id}`);
                if (response.ok) {
                    const result = await response.json();
                    populateGenerationPage(result.data);
                    showPage('generate');
                } else {
                    throw new Error('Failed to load assignment');
                }
            } catch (error) {
                showToast('Failed to load assignment for generation', 'error');
            }
        }

        // Utility Functions
        function showStatus(containerId, message, type) {
            const container = document.getElementById(containerId);
            const messageEl = document.getElementById(containerId.replace('Status', 'Message'));
            
            container.className = `status-container status-${type}`;
            messageEl.innerHTML = message;
            container.style.display = 'block';
        }

        function updateProgress(progressId, percentage) {
            const progressEl = document.getElementById(progressId);
            if (progressEl) {
                progressEl.style.width = percentage + '%';
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 1000);
        }

        function updateApiUrl() {
            const newUrl = document.getElementById('apiUrlInput').value;
            if (newUrl) {
                API_BASE_URL = newUrl;
                localStorage.setItem('apiUrl', newUrl);
                showToast('API URL updated successfully!', 'success');
            }
        }


        // toggle dark and ligth mode
        // Apply theme and save it to localStorage
        function toggleTheme(theme) {
            const body = document.body;

            // Save theme choice
            localStorage.setItem('theme', theme);

            // Apply classes
            if (theme === 'dark') {
                body.classList.remove('light-theme');
                body.classList.add('dark-theme');
                return;
            } else {
                body.classList.remove('dark-theme');
                body.classList.add('light-theme');
            }

            showToast(`Switched to ${theme} mode.`, "success");
        }

        // Toggle based on switch state
        function toggleSwitchTheme(switchEl) {
            const theme = switchEl.checked ? 'dark' : 'light';
            toggleTheme(theme);
            localStorage.setItem('theme', theme);
        }



        // Error Handling
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            showToast('An unexpected error occurred. Please try again.', 'error');
        });

        // Network Status
        window.addEventListener('online', function() {
            showToast('Connection restored', 'success');
        });

        window.addEventListener('offline', function() {
            showToast('Connection lost. Please check your internet.', 'error');
        });
    </script>
</body>
</html>